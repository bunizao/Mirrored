console.log("🍿 DualSubs: 🎵 Spotify Request");const e=function(){if("undefined"!=typeof $environment&&$environment["surge-version"])return"Surge";if("undefined"!=typeof $environment&&$environment["stash-version"])return"Stash";if("undefined"!=typeof module&&module.exports)return"Node.js";if("undefined"!=typeof $task)return"Quantumult X";if("undefined"!=typeof $loon)return"Loon";if("undefined"!=typeof $rocket)return"Shadowrocket";if("undefined"!=typeof Egern)return"Egern"}();class t{static name="Lodash";static version="1.2.2";static about(){return console.log(`\n🟧 ${this.name} v${this.version}\n`)}static get(e={},t="",s=void 0){Array.isArray(t)||(t=this.toPath(t));const a=t.reduce(((e,t)=>Object(e)[t]),e);return void 0===a?s:a}static set(e={},t="",s){return Array.isArray(t)||(t=this.toPath(t)),t.slice(0,-1).reduce(((e,s,a)=>Object(e[s])===e[s]?e[s]:e[s]=/^\d+$/.test(t[a+1])?[]:{}),e)[t[t.length-1]]=s,e}static unset(e={},t=""){return Array.isArray(t)||(t=this.toPath(t)),t.reduce(((e,s,a)=>a===t.length-1?(delete e[s],!0):Object(e)[s]),e)}static toPath(e){return e.replace(/\[(\d+)\]/g,".$1").split(".").filter(Boolean)}static escape(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return e.replace(/[&<>"']/g,(e=>t[e]))}static unescape(e){const t={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};return e.replace(/&amp;|&lt;|&gt;|&quot;|&#39;/g,(e=>t[e]))}}class s{static name="Storage";static version="1.1.0";static about(){return o("",`🟧 ${this.name} v${this.version}`,"")}static data=null;static dataFile="box.dat";static#e=/^@(?<key>[^.]+)(?:\.(?<path>.*))?$/;static getItem(s=new String,a=null){let r=a;if(!0===s.startsWith("@")){const{key:e,path:a}=s.match(this.#e)?.groups;s=e;let o=this.getItem(s,{});"object"!=typeof o&&(o={}),r=t.get(o,a);try{r=JSON.parse(r)}catch(e){}}else{switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":r=$persistentStore.read(s);break;case"Quantumult X":r=$prefs.valueForKey(s);break;case"Node.js":this.data=this.#t(this.dataFile),r=this.data?.[s];break;default:r=this.data?.[s]||null}try{r=JSON.parse(r)}catch(e){}}return r??a}static setItem(s=new String,a=new String){let r=!1;if("object"==typeof a)a=JSON.stringify(a);else a=String(a);if(!0===s.startsWith("@")){const{key:e,path:o}=s.match(this.#e)?.groups;s=e;let i=this.getItem(s,{});"object"!=typeof i&&(i={}),t.set(i,o,a),r=this.setItem(s,i)}else switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":r=$persistentStore.write(a,s);break;case"Quantumult X":r=$prefs.setValueForKey(a,s);break;case"Node.js":this.data=this.#t(this.dataFile),this.data[s]=a,this.#s(this.dataFile),r=!0;break;default:r=this.data?.[s]||null}return r}static removeItem(s){let a=!1;if(!0===s.startsWith("@")){const{key:e,path:r}=s.match(this.#e)?.groups;s=e;let o=this.getItem(s);"object"!=typeof o&&(o={}),keyValue=t.unset(o,r),a=this.setItem(s,o)}else switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Node.js":default:a=!1;break;case"Quantumult X":a=$prefs.removeValueForKey(s)}return a}static clear(){let t=!1;switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Node.js":default:t=!1;break;case"Quantumult X":t=$prefs.removeAllValues()}return t}static#t(e){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(e),s=this.path.resolve(process.cwd(),e),a=this.fs.existsSync(t),r=!a&&this.fs.existsSync(s);if(!a&&!r)return{};{const e=a?t:s;try{return JSON.parse(this.fs.readFileSync(e))}catch(e){return{}}}}}static#s(e=this.dataFile){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(e),s=this.path.resolve(process.cwd(),e),a=this.fs.existsSync(t),r=!a&&this.fs.existsSync(s),o=JSON.stringify(this.data);a?this.fs.writeFileSync(t,o):r?this.fs.writeFileSync(s,o):this.fs.writeFileSync(t,o)}}}async function a(s={}||"",a={}){switch(s.constructor){case Object:s={...a,...s};break;case String:s={...a,url:s}}s.method||(s.method="GET",(s.body??s.bodyBytes)&&(s.method="POST")),delete s.headers?.Host,delete s.headers?.[":authority"],delete s.headers?.["Content-Length"],delete s.headers?.["content-length"];const r=s.method.toLocaleLowerCase();switch(e){case"Loon":case"Surge":case"Stash":case"Egern":case"Shadowrocket":default:if(s.timeout)switch(s.timeout=parseInt(s.timeout,10),e){case"Loon":case"Shadowrocket":case"Stash":case"Egern":default:s.timeout=s.timeout/1e3;case"Surge":}if(s.policy)switch(e){case"Loon":s.node=s.policy;break;case"Stash":t.set(s,"headers.X-Stash-Selected-Proxy",encodeURI(s.policy));break;case"Shadowrocket":t.set(s,"headers.X-Surge-Proxy",s.policy)}return"boolean"==typeof s.redirection&&(s["auto-redirect"]=s.redirection),s.bodyBytes&&!s.body&&(s.body=s.bodyBytes,delete s.bodyBytes),await new Promise(((e,t)=>{$httpClient[r](s,((a,r,o)=>{a?t(a):(r.ok=/^2\d\d$/.test(r.status),r.statusCode=r.status,o&&(r.body=o,1==s["binary-mode"]&&(r.bodyBytes=o)),e(r))}))}));case"Quantumult X":return s.policy&&t.set(s,"opts.policy",s.policy),"boolean"==typeof s["auto-redirect"]&&t.set(s,"opts.redirection",s["auto-redirect"]),s.body instanceof ArrayBuffer?(s.bodyBytes=s.body,delete s.body):ArrayBuffer.isView(s.body)?(s.bodyBytes=s.body.buffer.slice(s.body.byteOffset,s.body.byteLength+s.body.byteOffset),delete object.body):s.body&&delete s.bodyBytes,await $task.fetch(s).then((e=>(e.ok=/^2\d\d$/.test(e.statusCode),e.status=e.statusCode,e)),(e=>Promise.reject(e.error)));case"Node.js":let a=require("iconv-lite");!function(e){this.got=this.got?this.got:require("got"),this.cktough=this.cktough?this.cktough:require("tough-cookie"),this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar,e&&(e.headers=e.headers?e.headers:{},void 0===e.headers.Cookie&&void 0===e.cookieJar&&(e.cookieJar=this.ckjar))}(s);const{url:o,...i}=s;return await this.got[r](o,i).on("redirect",((e,t)=>{try{if(e.headers["set-cookie"]){const s=e.headers["set-cookie"].map(this.cktough.Cookie.parse).toString();s&&this.ckjar.setCookieSync(s,null),t.cookieJar=this.ckjar}}catch(e){this.logErr(e)}})).then((e=>(e.statusCode=e.status,e.body=a.decode(e.rawBody,"utf-8"),e.bodyBytes=e.rawBody,e)),(e=>Promise.reject(e.message)))}}function r(s={}){switch(e){case"Surge":s.policy&&t.set(s,"headers.X-Surge-Policy",s.policy),o("",`🚩 执行结束! 🕛 ${(new Date).getTime()/1e3-$script.startTime} 秒`,""),$done(s);break;case"Loon":s.policy&&(s.node=s.policy),o("",`🚩 执行结束! 🕛 ${(new Date-$script.startTime)/1e3} 秒`,""),$done(s);break;case"Stash":s.policy&&t.set(s,"headers.X-Stash-Selected-Proxy",encodeURI(s.policy)),o("",`🚩 执行结束! 🕛 ${(new Date-$script.startTime)/1e3} 秒`,""),$done(s);break;case"Egern":case"Shadowrocket":default:o("","🚩 执行结束!",""),$done(s);break;case"Quantumult X":s.policy&&t.set(s,"opts.policy",s.policy),delete s["auto-redirect"],delete s["auto-cookie"],delete s["binary-mode"],delete s.charset,delete s.host,delete s.insecure,delete s.method,delete s.opt,delete s.path,delete s.policy,delete s["policy-descriptor"],delete s.scheme,delete s.sessionIndex,delete s.statusCode,delete s.timeout,s.body instanceof ArrayBuffer?(s.bodyBytes=s.body,delete s.body):ArrayBuffer.isView(s.body)?(s.bodyBytes=s.body.buffer.slice(s.body.byteOffset,s.body.byteLength+s.body.byteOffset),delete s.body):s.body&&delete s.bodyBytes,o("","🚩 执行结束!",""),$done(s);break;case"Node.js":o("","🚩 执行结束!",""),process.exit(1)}}const o=(...e)=>console.log(e.join("\n"));var i={Switch:!0,Type:"Translate",Types:["Official","Translate"],Languages:["EN","ZH"],CacheSize:50},c={breakLine:{"text/xml":"&#x000A;","application/xml":"&#x000A;","text/vtt":"\n","application/vtt":"\n","text/json":"\n","application/json":"\n"}},n={Settings:i,Configs:c},l={Switch:!0,Types:["Translate","External"],Languages:["AUTO","ZH"]},d={Settings:l},u=Database={Default:Object.freeze({__proto__:null,Configs:c,Settings:i,default:n}),Spotify:Object.freeze({__proto__:null,Settings:l,default:d})};function h(e,a,r){o("☑️ Set Environment Variables","");let{Settings:i,Caches:c,Configs:n}=function(e,a,r){let o=s.getItem(e,r),i={};switch(typeof $argument){case"string":let e=Object.fromEntries($argument.split("&").map((e=>e.split("=").map((e=>e.replace(/\"/g,""))))));for(let s in e)t.set(i,s,e[s]);break;case"object":for(let e in $argument)t.set(i,e,$argument[e])}const c={Settings:r?.Default?.Settings||{},Configs:r?.Default?.Configs||{},Caches:{}};Array.isArray(a)||(a=[a]);for(let e of a)c.Settings={...c.Settings,...r?.[e]?.Settings,...i,...o?.[e]?.Settings},c.Configs={...c.Configs,...r?.[e]?.Configs},o?.[e]?.Caches&&"string"==typeof o?.[e]?.Caches&&(o[e].Caches=JSON.parse(o?.[e]?.Caches)),c.Caches={...c.Caches,...o?.[e]?.Caches};return function e(t,s){for(var a in t){var r=t[a];t[a]="object"==typeof r&&null!==r?e(r,s):s(a,r)}return t}(c.Settings,((e,t)=>("true"===t||"false"===t?t=JSON.parse(t):"string"==typeof t&&(t=t.includes(",")?t.split(",").map((e=>n(e))):n(t)),t))),c;function n(e){return e&&!isNaN(e)&&(e=parseInt(e,10)),e}}(e,a,r);return Array.isArray(i?.Types)||(i.Types=i.Types?[i.Types]:[]),o(`✅ Set Environment Variables, Settings: ${typeof i}, Settings内容: ${JSON.stringify(i)}`,""),("object"!=typeof c?.Playlists||Array.isArray(c?.Playlists))&&(c.Playlists={}),c.Playlists.Master=new Map(JSON.parse(c?.Playlists?.Master||"[]")),c.Playlists.Subtitle=new Map(JSON.parse(c?.Playlists?.Subtitle||"[]")),"object"!=typeof c?.Subtitles&&(c.Subtitles=new Map(JSON.parse(c?.Subtitles||"[]"))),("object"!=typeof c?.Metadatas||Array.isArray(c?.Metadatas))&&(c.Metadatas={}),"object"!=typeof c?.Metadatas?.Tracks&&(c.Metadatas.Tracks=new Map(JSON.parse(c?.Metadatas?.Tracks||"[]"))),{Settings:i,Caches:c,Configs:n}}let p;o("v1.5.0(1006)");const y=new URL($request.url);o(`⚠ url: ${y.toJSON()}`,"");const f=$request.method,g=y.hostname,b=y.pathname,S=y.pathname.split("/").filter(Boolean);o(`⚠ METHOD: ${f}, HOST: ${g}, PATH: ${b}`,"");const m=($request.headers?.["Content-Type"]??$request.headers?.["content-type"])?.split(";")?.[0];o(`⚠ FORMAT: ${m}`,""),(async()=>{const{Settings:t,Caches:r,Configs:i}=h("DualSubs","Spotify",u);switch(o(`⚠ Settings.Switch: ${t?.Switch}`,""),t.Switch){case!0:default:const i=y.searchParams.get("subtype")??t.Type,c=[y.searchParams.get("lang")?.toUpperCase?.()??t.Languages[0],(y.searchParams.get("tlang")??r?.tlang)?.toUpperCase?.()??t.Languages[1]];o(`⚠ Type: ${i}, Languages: ${c}`,"");let n={};switch(f){case"POST":case"PUT":case"PATCH":case"DELETE":switch(m){case void 0:case"application/x-www-form-urlencoded":case"text/plain":default:case"application/x-mpegURL":case"application/x-mpegurl":case"application/vnd.apple.mpegurl":case"audio/mpegurl":case"text/xml":case"text/html":case"text/plist":case"application/xml":case"application/plist":case"application/x-plist":case"text/vtt":case"application/vtt":case"text/json":case"application/json":break;case"application/protobuf":case"application/x-protobuf":case"application/vnd.google.protobuf":case"application/grpc":case"application/grpc+proto":case"application/octet-stream":let t="Quantumult X"===e?new Uint8Array($request.bodyBytes??[]):$request.body??new Uint8Array;switch(m){case"application/protobuf":case"application/x-protobuf":case"application/vnd.google.protobuf":switch(b){case"/bootstrap/v1/bootstrap":case"/user-customization-service/v1/customize":delete $request.headers?.["If-None-Match"],delete $request.headers?.["if-none-match"]}}$request.body=t}case"GET":if(b.startsWith("/color-lyrics/v2/track/")){let e=S?.[3];o("🚧 调试信息",`trackId: ${e}`,"");let i=JSON.parse(JSON.stringify($request));i.url=`https://api.spotify.com/v1/tracks?ids=${e}`,i?.headers?.Accept&&(i.headers.Accept="application/json"),i?.headers?.accept&&(i.headers.accept="application/json");const c=a($request),l=a(i);await Promise.allSettled([c,l]).then((e=>{switch(e[0].status){case"fulfilled":let s=e[0].value;switch(s?.statusCode??s?.status){case 200:t.Types.includes("Translate")?y.searchParams.set("subtype","Translate"):t.Types.includes("External")&&y.searchParams.set("subtype","External");break;case 401:default:break;case 404:t.Types.includes("External")&&y.searchParams.set("subtype","External")}break;case"rejected":t.Types.includes("External")&&y.searchParams.set("subtype","External")}switch(e[1].status){case"fulfilled":let a=e[1].value;n=JSON.parse(a.body),n?.tracks?.forEach?.((e=>{const t=e?.id,s={id:e?.id,track:e?.name,album:e?.album?.name,artist:e?.artists?.[0]?.name};r.Metadatas.Tracks.set(t,s)})),r.Metadatas.Tracks=function(e,t=100){return console.log(`☑️ Set Cache, cacheSize: ${t}`,""),e=(e=Array.from(e||[])).slice(-t),console.log("✅ Set Cache",""),e}(r.Metadatas.Tracks,t.CacheSize),s.setItem("@DualSubs.Spotify.Caches.Metadatas.Tracks",r.Metadatas.Tracks);break;case"rejected":o("🚧 调试信息",`detectTrack.reason: ${JSON.stringify(e[1].reason)}`,"")}}))}}$request.url=y.toString(),o("🚧 调试信息",`$request.url: ${$request.url}`,"");case!1:}})().catch((t=>function(t){switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Quantumult X":default:o("","❗️执行错误!",t,"");break;case"Node.js":o("","❗️执行错误!",t.stack,"")}}(t))).finally((()=>{if(void 0===p)r($request);else if(p.headers,p.headers,"Quantumult X"===e)p.status||(p.status="HTTP/1.1 200 OK"),delete p.headers?.["Content-Length"],delete p.headers?.["content-length"],delete p.headers?.["Transfer-Encoding"],r(p);else r({response:p})}));
