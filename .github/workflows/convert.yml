name: Extract plugin URLs & build sgmodule

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '5,30,55 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    services:
      docker:
        image: xream/script-hub:latest
        ports: [9100:9100, 9101:9101]

    env:
      MIRROR_RAW:  https://github.com/bunizao/Mirrored/raw/main/Chores/js
      MIRROR_KEY:  github.com/bunizao/Mirrored        # æ’é™¤æ¡ä»¶

    steps:
      - uses: actions/checkout@v3

      - name: Setup git identity
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install curl jq netcat
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y curl jq netcat-openbsd

      - name: Wait for Script-Hub container (:9101)
        run: |
          for i in {1..20}; do
            nc -z localhost 9101 && exit 0
            sleep 5
          done
          echo "::error ::container not ready"; exit 1

      # ---------- 1. æŠ“ README è§£æ .plugin ----------
      - name: Download ProxyResource README
        run: |
          curl -s -o README.md https://raw.githubusercontent.com/luestr/ProxyResource/main/README.md

      - name: Extract .plugin URLs
        run: |
          grep -oP 'https?://[^ )"]+\?plugin=[^ )"]+' README.md > plugin_urls_raw.txt
          grep -oP '(?<=\?plugin=)[^ )"]+'           plugin_urls_raw.txt > plugin_urls.txt

      # ---------- 2. è°ƒ Script-Hub ç”Ÿæˆ .sgmodule ----------
      - name: Generate sgmodule files
        run: |
          mkdir -p Chores/sgmodule
          category="ğŸš« AD Block"
          enc_cat=$(echo "$category" | jq -sRr @uri)
          while read -r plugin_url; do
            [ -z "$plugin_url" ] && continue
            name=$(basename "$plugin_url" .plugin)
            enc=$(echo "$name" | jq -sRr @uri)
            url="http://localhost:9101/file/_start_/${plugin_url}/_end_/${enc}.sgmodule?type=loon-plugin&target=surge-module&category=$enc_cat"
            echo "â†“  $url"
            curl -Ls -A "Surge Mac/2985" "$url" -o "Chores/sgmodule/$name.sgmodule" \
              || echo "::warning ::Failed to download $name.sgmodule"
          done < plugin_urls.txt

      # ---------- 3. é•œåƒå¤–éƒ¨ JS å¹¶æ›¿æ¢é“¾æ¥ ----------
      - name: Mirror external JS & rewrite links
        shell: bash
        run: |
          set -e
          mkdir -p Chores/js
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç”Ÿæˆçš„ sgmodule æ–‡ä»¶
          if [ ! -d "Chores/sgmodule" ] || [ -z "$(ls -A Chores/sgmodule 2>/dev/null)" ]; then
            echo "No sgmodule files found to process"
            exit 0
          fi
          
          echo "Generated sgmodule files:"
          ls -la Chores/sgmodule/
        
          
          # æå–æ‰€æœ‰ JavaScript URL
          echo "Searching for JS URLs..."
          
          # ä½¿ç”¨æ›´ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… script-path åçš„ URL
          find Chores/sgmodule -name "*.sgmodule" \
            -exec grep -hoE 'script-path\s*=\s*https?://[^[:space:],"]+\.js[^[:space:],"]*' {} \; 2>/dev/null \
            | sed -E 's/^script-path\s*=\s*//' \
            | sort -u > external-js-raw.txt || touch external-js-raw.txt
          
          echo "Found JavaScript URLs:"
          cat external-js-raw.txt || echo "No JS URLs found"
          
          # è¿‡æ»¤æ‰å·²ç»æŒ‡å‘é•œåƒçš„ URL
          if [ -s external-js-raw.txt ]; then
            grep -v "$MIRROR_KEY" external-js-raw.txt \
              | grep -v "$MIRROR_RAW" > external-js.txt \
              || touch external-js.txt
          else
            touch external-js.txt
          fi
          
          echo "External JS URLs to mirror:"
          cat external-js.txt || echo "No external JS URLs to mirror"

          # å¦‚æœæ²¡æœ‰éœ€è¦é•œåƒçš„ JS æ–‡ä»¶ï¼Œç›´æ¥é€€å‡º
          if [ ! -s external-js.txt ]; then
            echo "No external JS links found to mirror."
            rm -f external-js.txt external-js-raw.txt
            exit 0
          fi

          # ä¸‹è½½å¹¶é•œåƒ JS æ–‡ä»¶
          echo "Processing external JS files:"
          failed_downloads=0
          while IFS= read -r url; do
            [ -z "$url" ] && continue
            
            # æå–æ–‡ä»¶åï¼Œå¤„ç†å¯èƒ½çš„æŸ¥è¯¢å‚æ•°
            filename=$(basename "${url%%[\?#]*}")
            
            # ç¡®ä¿æ–‡ä»¶åä»¥ .js ç»“å°¾
            if [[ ! "$filename" =~ \.js$ ]]; then
              filename="${filename}.js"
            fi
            
            echo "Mirroring: $url â†’ Chores/js/$filename"
            
            if curl -Ls -A "Surge Mac/3272" --connect-timeout 30 --max-time 60 "$url" -o "Chores/js/$filename"; then
              # æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶æ˜¯å¦ä¸ºç©ºæˆ–è¿‡å°
              if [ -s "Chores/js/$filename" ] && [ "$(stat -c%s "Chores/js/$filename")" -gt 10 ]; then
                echo "âœ“ Successfully downloaded $filename"
                
                # åœ¨æ‰€æœ‰ sgmodule æ–‡ä»¶ä¸­æ›¿æ¢é“¾æ¥
                mirror_url="$MIRROR_RAW/$filename"
                find Chores/sgmodule -name "*.sgmodule" -type f \
                  -exec perl -pi -e "s,\Q${url}\E,${mirror_url},g" {} \;
                
                echo "âœ“ Updated links: $url â†’ $mirror_url"
              else
                echo "âœ— Downloaded file is empty or too small: $filename"
                rm -f "Chores/js/$filename"
                ((failed_downloads++))
              fi
            else
              echo "âœ— Failed to download: $url"
              ((failed_downloads++))
            fi
          done < external-js.txt
          
          echo "Processing complete. Failed downloads: $failed_downloads"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f external-js.txt external-js-raw.txt

      - name: Commit & push (if changed)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
          if [ ! -d "Chores/sgmodule" ] && [ ! -d "Chores/js" ]; then
            echo "No files to commit."
            exit 0
          fi

          # æš‚å­˜éœ€è¦ç®¡æ§çš„æ–‡ä»¶
          git add Chores/sgmodule Chores/js 2>/dev/null || true

          # æ£€æŸ¥æš‚å­˜åŒºæ˜¯å¦ä¸ºç©º
          if git diff --cached --quiet; then
            echo "Nothing to commit."
            exit 0
          fi

          # æ˜¾ç¤ºå°†è¦æäº¤çš„å˜åŒ–
          echo "Changes to be committed:"
          git diff --cached --name-status

          # åŒæ­¥è¿œç«¯å˜åŒ–
          git fetch origin
          if git diff --quiet HEAD origin/main; then
            echo "Local branch is up to date with origin/main"
          else
            echo "Pulling latest changes from origin..."
            git pull --rebase origin main
            
            # rebase åé‡æ–°æ·»åŠ æ–‡ä»¶
            git add Chores/sgmodule Chores/js 2>/dev/null || true
            
            # rebase åå†æ¬¡æ£€æŸ¥
            if git diff --cached --quiet; then
              echo "Nothing to commit after rebase."
              exit 0
            fi
          fi

          # æäº¤å˜åŒ–
          commit_msg="Update sgmodule & mirror JS files - $(date '+%Y-%m-%d %H:%M:%S UTC')"
          git commit -m "$commit_msg"
          
          echo "Pushing changes..."
          git push origin main
          
          echo "âœ“ Successfully committed and pushed changes"
