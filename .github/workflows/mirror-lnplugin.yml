name: Mirror LNPlugin Artifacts

on:
  schedule:
    - cron: '10,35,59 * * * *'
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      # ä¸»æº + å¤‡ç”¨æºï¼ˆå¯ç»§ç»­å¾€ä¸‹åŠ ï¼‰
      SOURCE_URL: https://hub.kelee.one/list.json
      FALLBACK_URL_1: https://pluginhub.kelee.one/list.json

      # è¯·æ±‚å¤´ä¸Žè¡Œä¸º
      USER_AGENT: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
      ACCEPT_HEADER: 'application/json, text/plain, */*'
      REFERER: 'https://pluginhub.kelee.one/'
      # è°ƒè¯•æ€»å¼€å…³ï¼š1 å¼€ 0 å…³
      DEBUG_CURL: '1'

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Configure git author
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download plugin catalog (with fallback & debug)
        run: |
          set -euo pipefail

          urls=()
          urls+=("${SOURCE_URL}")
          [ -n "${FALLBACK_URL_1:-}" ] && urls+=("${FALLBACK_URL_1}")

          # ç»„è£… curl é€šç”¨å‚æ•°
          base_flags=(--fail --show-error --location --compressed --http1.1 \
                      --retry 5 --retry-all-errors --connect-timeout 20 --max-time 120 \
                      -A "$USER_AGENT" -H "Accept: $ACCEPT_HEADER" -e "$REFERER")

          fetch_ok=false
          rm -f plugin_data.json || true

          for u in "${urls[@]}"; do
            echo "::group::Preflight HEAD ${u}"
            # é¢„æ£€å“åº”å¤´ï¼Œä¾¿äºŽåˆ¤æ–­ 403/WAF
            if [ "${DEBUG_CURL}" = "1" ]; then
              curl -sS -I --http1.1 -A "$USER_AGENT" -H "Accept: $ACCEPT_HEADER" -e "$REFERER" "$u" | tee curl_head.log || true
            else
              curl -sS -I --http1.1 -A "$USER_AGENT" -H "Accept: $ACCEPT_HEADER" -e "$REFERER" "$u" || true
            fi
            echo "::endgroup::"

            echo "::group::GET ${u}"
            # æ ¹æ® DEBUG å¼€å…³å†³å®šæ˜¯å¦ -v å¹¶ä¿å­˜è°ƒè¯•æ—¥å¿—
            if [ "${DEBUG_CURL}" = "1" ]; then
              curl "${base_flags[@]}" -v "$u" -o plugin_data.json 2>curl_debug.log || true
            else
              curl "${base_flags[@]}" "$u" -o plugin_data.json || true
            fi
            echo "::endgroup::"

            # æ ¡éªŒæ–‡ä»¶éžç©º + å¯è§£æž JSON
            if [ -s plugin_data.json ]; then
              if command -v jq >/dev/null 2>&1; then
                if jq . >/dev/null 2>&1 < plugin_data.json; then
                  echo "âœ“ Catalog downloaded from ${u}"
                  fetch_ok=true
                  break
                else
                  echo "::warning ::Downloaded catalog not valid JSON from ${u}"
                  rm -f plugin_data.json
                fi
              else
                # æ²¡æœ‰ jq æ—¶ä»…æ£€æŸ¥éžç©º
                echo "âœ“ Catalog downloaded (jq not present) from ${u}"
                fetch_ok=true
                break
              fi
            else
              echo "::warning ::Empty response from ${u}"
              rm -f plugin_data.json || true
            fi
          done

          # å¦‚å¤±è´¥ï¼Œè¾“å‡ºè°ƒè¯•æ—¥å¿—
          if [ "${fetch_ok}" != "true" ]; then
            echo "::group::curl debug logs"
            [ -f curl_head.log ] && cat curl_head.log || true
            [ -f curl_debug.log ] && tail -n +1 curl_debug.log || true
            echo "::endgroup::"
            echo "::error ::Failed to download plugin catalog from all sources"
            exit 1
          fi

      - name: Extract LNPlugin URLs
        run: |
          set -euo pipefail
          python3 scripts/extract_lnplugin_urls.py \
            --input plugin_data.json \
            --output lnplugin_urls.txt

      - name: Mirror LNPlugin packages (debug-ready)
        run: |
          set -euo pipefail
          mkdir -p Chores/lnplugin

          mapfile -t urls < lnplugin_urls.txt
          if [ "${#urls[@]}" -eq 0 ]; then
            echo "::error ::No LNPlugin URLs to mirror"
            exit 1
          fi

          declare -A seen
          updated=false

          for filepath in Chores/lnplugin/*.lpx; do
            if [ -e "$filepath" ]; then
              seen["$(basename "$filepath")"]=false
            fi
          done

          base_flags=(--fail --show-error --location --compressed --http1.1 \
                      --retry 5 --retry-all-errors --connect-timeout 30 --max-time 120 \
                      -A "$USER_AGENT" -H "Accept: $ACCEPT_HEADER")

          for url in "${urls[@]}"; do
            url="${url//$'\r'/}"
            url="${url//$'\n'/}"
            [ -z "$url" ] && continue

            sanitized="${url%%[\?#]*}"
            filename="$(basename "$sanitized")"
            filename="${filename//$'\r'/}"
            filename="${filename//$'\n'/}"

            if [[ -z "$filename" ]]; then
              echo "::warning ::Skipping malformed URL: $url"
              continue
            fi
            if [[ ! "$filename" =~ \.lpx$ ]]; then
              filename="${filename}.lpx"
            fi

            temp_file="Chores/lnplugin/$filename.tmp"
            final_file="Chores/lnplugin/$filename"

            echo "â†“  $url"
            if [ "${DEBUG_CURL}" = "1" ]; then
              echo "::group::curl $filename"
              curl "${base_flags[@]}" -v "$url" -o "$temp_file" 2> "curl_${filename}.log" || true
              echo "::endgroup::"
            else
              curl "${base_flags[@]}" "$url" -o "$temp_file" || true
            fi

            if [ -s "$temp_file" ]; then
              if ! cmp -s "$temp_file" "$final_file" 2>/dev/null; then
                mv "$temp_file" "$final_file"
                updated=true
                echo "âœ“ Mirrored $filename"
              else
                rm -f "$temp_file"
                echo "= $filename unchanged"
              fi
            else
              echo "::warning ::Downloaded file empty: $filename"
              rm -f "$temp_file"
            fi

            seen["$filename"]=true
          done

          for filename in "${!seen[@]}"; do
            if [ "${seen[$filename]}" = false ]; then
              echo "Removing stale artifact: $filename"
              rm -f "Chores/lnplugin/$filename"
              updated=true
            fi
          done

          if [ "$updated" = true ]; then
            echo "MIRROR_UPDATED=true" >> "$GITHUB_ENV"
          else
            echo "MIRROR_UPDATED=false" >> "$GITHUB_ENV"
          fi

      - name: Commit and push changes
        if: env.MIRROR_UPDATED == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git add Chores/lnplugin

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git fetch origin
          git pull --rebase origin main
          git add Chores/lnplugin

          timestamp=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          git commit -m "ðŸªž Mirror LNPlugin artifacts - $timestamp (UTC+8)"
          git push origin main

      - name: No updates detected
        if: env.MIRROR_UPDATED != 'true'
        run: echo "LNPlugin artifacts already up to date"
